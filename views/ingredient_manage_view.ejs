<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Quản lý sản phẩm</h1>
    </div>
    <!-- /.col-lg-12 -->
</div>
<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                Danh sách sản phẩm
            </div>
            <!-- /.panel-heading -->
            <div class="panel-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover" id="list-item">
                        <thead>
                          <tr>
                              <th>Mã</th>
                              <th>Nguyên Liệu</th>
                              <th>Loại</th>
                              <th>Mô Tả</th>
                              <th>Trạng Thái</th>
                              <th>Đơn Vị</th>
                              <th>&nbsp;</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% _.each(data, function (obj) { %>
                            <tr>
                              <td><%= obj.id %></td>
                              <td><%= obj.name %></td>
                              <td><%= obj.category.name %></td>

                              <% if (obj.description == undefined) { %>
                                <td></td>
                              <% } else { %>
                                <td><%= obj.description %></td>
                              <% } %>
                              
                              <% if (obj.deleted == true) { %>
                                <td>Đã xóa</td>
                              <% } else { %>
                                <td>Kích hoạt</td>
                              <% } %> 

                              <td><%= obj.unit %></td>


                              <td>
                                <button type="button" class="btn btn-primary update">Cập nhật</button> 
                                <button type="button" class="btn btn-danger remove">Xóa</button>
                              </td>                            
                            </tr>
                          <% }) %>
                        </tbody>
                    </table>
                </div>
                <!-- /.table-responsive -->
                <div class="text-center">
                    <button type="submit" id="btnAddIngredient" onClick="addIngredient()" class="btn btn-lg btn-primary add">Thêm nguyên liệu</button>
                </div>
            </div>
            <!-- /.panel-body -->
        </div>
        <!-- /.panel -->

        <div id="form" class="modal fade">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Thêm nguyên liệu</h4>
              </div>
              <div class="modal-body">
                <div id="message" class="alert alert-danger" role="alert" style="display: none;"></div>
                <form role="form">
                  <div class="form-group">
                    <label for="ingredient-name">Tên nguyên liệu</label>
                    <input type="hidden" class="form-control" id="hd-action-type">
                    <input type="hidden" class="form-control" id="hd-ingredient-id">
                    <input type="text" class="form-control" id="ingredient-name" placeholder="Tên nguyên liệu">
                  </div>
                  <div class="form-group">
                    <label for="ingredient-category">Loại nguyên liệu</label>
                    <select class="form-control" id="ingredient-category"></select>
                  </div>
                  <div class="form-group">
                    <label for="ingredient-description">Mô tả</label>
                    <input type="text" class="form-control" id="ingredient-description" placeholder="Mô tả">
                  </div>
                  <div class="form-group">
                      <label for="ingredient-status">Trạng thái </label>
                      <label class="radio-inline">
                          <input type="radio" name="ingredient-status" id="rdoStatus1" value="true">Xóa
                      </label>
                      <label class="radio-inline">
                          <input type="radio" name="ingredient-status" id="rdoStatus2" value="false">Kích hoạt
                      </label>
                  </div>
                  <div class="form-group">
                    <label for="ingredient-unit">Đơn vị</label>
                    <input type="hidden" class="form-control" id="hd-action-type">
                    <input type="hidden" class="form-control" id="hd-ingredient-id">
                    <input type="text" class="form-control" id="ingredient-unit" placeholder="Đơn vị">
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Thoát</button>
                <button type="submit" onClick="save()" class="btn btn-primary">Lưu thông tin</button>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

    </div>
    <!-- /.col-lg-12 -->
</div>
<script type="text/javascript" charset="utf-8">
    $(document).ready(function() {
        $('#list-item').DataTable();

        //Load Ingredient Category
        $.get( '/services/model?from=ingredientCategory&where={"deleted": 0}', function( data ) {
          var categories = data.ingredientcategory;
          $.each( categories, function( key, value ) {
            //Key: is index
            // console.log("key: "+key);
            //Value: is obj category
            //Ex: 
              // {
              //     "id": 1,
              //     "name": "Sinh tố",
              //     "description": "Sinh tố trái cây",
              //     "deleted": null,
              //     "createdAt": "2015-01-09T08:14:55.000Z",
              //     "updatedAt": "2015-01-09T08:14:55.000Z"
              // }
            // console.log("value: "+value);
            $('#ingredient-category').append('<option value='+value.id+'>'+value.name+'</option>');
          });
        });


        //Load Ingredient Category
        $.get( '/services/model?from=store&where={"deleted": 0}', function( data ) {
          var stores = data.store;
          $.each( stores, function( key, value ) {
            //Key: is index
            // console.log("key: "+key);
            //Value: is obj category
            //Ex: 
              // {
              //     "id": 1,
              //     "name": "Sinh tố",
              //     "description": "Sinh tố trái cây",
              //     "deleted": null,
              //     "createdAt": "2015-01-09T08:14:55.000Z",
              //     "updatedAt": "2015-01-09T08:14:55.000Z"
              // }
            // console.log("value: "+value);
            $('#ingredient-store').append('<option value='+value.id+'>'+value.name+'</option>');
          });
        });
    });

    function addIngredient()
    {
      $('#message').hide();
      $('#form').modal();
      $('#hd-action-type').val("1");
    }

    function updateIngredient (ingredient) {
      $('#hd-action-type').val("0");      
      $('#hd-ingredient-id').val(ingredient.id);
      $('#ingredient-name').val(ingredient.name);      
      $('#ingredient-category').val(ingredient.category.id);
      $('#ingredient-description').val((ingredient.description == undefined) ? "" : ingredient.description);
      $('#ingredient-unit').val(ingredient.unit);

      var status = null;
      if(ingredient.deleted)
        status = "true";
      else
        status = "false";
      $('input:radio[name="ingredient-status"]').filter('[value='+status+']').prop('checked', true);

      $('#message').hide();
      $('#form').modal();
    }

    function save () {
      var type = $('#hd-action-type').val();
      var name = $('#ingredient-name').val();
      var category = $('#ingredient-category').val();
      // var store = $('#ingredient-store').val();
      var description = $('#ingredient-description').val();
      var unit = $('#ingredient-unit').val();
      // var limit = $('#ingredient-limit').val();
      var status = $('input[name=ingredient-status]:checked').val();

      //If type == 0 -> action is update
      //Else action is create
      var action = (type == 0) ? "update" : "create"
      var obj = {
                    "name": name,
                    "category": category,
                    // "store": store,
                    "description": description,
                    "unit": unit,
                    // "limit": limit,
                    "deleted": status

                };
      var data = {
                    "from": "ingredient",
                    "action": "create",
                    "createdata": JSON.stringify(obj)
                };
      $.post("/services/model", data)
        .done(function(data) 
        {
          if(data.status == 1)
          {
            ingredient = data.ingredient;
            //Get datatable
            var listItem = $('#list-item').DataTable();
            //Add new row to datatable
            listItem.row.add( [
                                ingredient.id,
                                ingredient.name,
                                $("#ingredient-category option:selected").text(), //The response does not include category name => get text from the selected dropdown list
                                // $("#ingredient-store option:selected").text(), //The response does not include category name => get text from the selected dropdown list
                                (ingredient.description == undefined) ? "" : ingredient.description,
                                ingredient.unit,
                                // ingredient.limit,
                                (ingredient.deleted == false) ? "Kích hoạt" : "Đã xóa",
                                "<button type='button' class='btn btn-primary update'>Cập nhật</button><button type='button' class='btn btn-danger remove'>Xóa</button>"
                              ] ).draw(false);
            //.draw(false) to prevent datatable reload to page 1
            //Hiện tại vẫn còn 1 lỗi nhỏ: khi qua trang mới thì datatable ko tự chuyển trang được (sẽ fix sau)
            $('#form').modal('hide');
            resetForm();
          }
          else
          {
            $('#message').text(data.message);
            $('#message').show();
          }
        })
        .fail(function(error)
        {
          $('#message').text('Không thể cập nhật nguyên liệu');
          $('#message').show();
        });
    }

    function resetForm()
    {
      $('#ingredient-name').val("");
      $('#ingredient-description').val("");
      $('#ingredient-unit').val("");
      // $('#ingredient-limit').val("");
      $('input[name=ingredient-status]').attr("checked", false);
    }
</script>