<link rel="stylesheet" href="//code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.3/jquery-ui.js"></script>

<!-- List of all low inventory ingredient -->
<div id="notification">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">Danh sách nguyên liệu cần nhập kho</h1>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover" id="list-item">
                            <thead>
                                <tr>
                                    <th>Mã kho</th>
                                    <th>Nguyên liệu</th>
                                    <th>Mô tả</th>
                                    <th>Giá</th>
                                    <th>Đơn vị</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-notification">
                                
                            </tbody>
                        </table>
                    </div>
                    <!-- /.table-responsive -->
                    <div class="text-center">
                        <button type="submit" id="btnAdd" onClick="add()" class="btn btn-lg btn-primary add">Nhập nguyên liệu</button>                    
                    </div>
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <!-- /.col-lg-12 -->
    </div>
</div>
<!-- End of List of all low inventory ingredient -->


<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Nhập kho</h1>
    </div> 
</div>
<div id="datepickerdiv" class="form-group">
                                                <input class="form-control" type="text" id="datepicker" placeholder=" Ngày nhập kho" onchange="ChangeDate();" onkeyup="ChangeDate();" onpaste="ChangeDate();" oninput="ChangeDate();">
                                                <label id="datepickerlbvalidate" class="form-control-static"></label>
                                            </div>
                                             <div id="receiptdiv" class="form-group">
                                                <input class="form-control" type="text" id="receipt" placeholder=" Số hóa đơn" onkeyup="receiptvalidate();" onpaste="receiptvalidate();" oninput="receiptvalidate();">
                                                <label id="receiptlbvalidate" class="form-control-static"></label>
                                            </div>
                                            <div id="notediv" class="form-group">
                                                <b>Ghi chú:</b>
                                                <textarea class="form-control" rows="3" id="note" onkeyup="ChangeTextArea();" onpaste="ChangeTextArea();" oninput="ChangeTextArea();"></textarea>
                                                <label class="form-control-static" id="notelbvalidate"></label>
                                            </div>
<div id="deleteform" class="modal fade">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Cảnh báo</h4>
              </div>
              <div class="modal-body">
                Bạn có chắc muốn hủy bỏ tất cả mọi thông tin đã nhập không?

              </div>
              <div class="modal-footer">
                <button type="button"  class="btn btn-primary update" data-dismiss="modal">Không</button>
                <button type="button" id="btncancel3" class="btn btn-danger remove">Có</button>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
<div id="confirmform" class="modal fade">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Xác nhận</h4>
              </div>
              <div class="modal-body">
                Bạn có chắc muốn thực hiện lệnh xuất kho không?

              </div>
              <div class="modal-footer">
                <button type="button"  class="btn btn-primary update" data-dismiss="modal">Không</button>
                <button type="button" id="btnchange1" data-dismiss="modal" class="btn btn-danger remove">Có</button>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
<div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class= "panel-body">
                    <div class="table-responsive">
                        <div  id="onestore">
                            <form>
                                <table class="table table-striped table-bordered table-hover">
                                    <thead>
                                        <th>
                                            Nguyên liệu
                                        </th>
                                        <th>
                                            Tồn kho
                                        </th>
                                        <th>
                                            Số lượng nhập
                                        </th>
                                        <th>
                                            
                                        </th>
                                    </thead>
                                    <tbody id="tbody1">
                                        <tr id="onestoretr1">
                                            <td>
                                                <div id="ingredientlistdiv1" class="form-group">
                                                <select id="ingredientlist1" onchange="ChangeIngredient(1);" class="form-control">
                                                    <option value="0">
                                                        Nguyên liệu
                                                    </option>
                                                </select>
                                                <div>
                                            </td>
                                            <td>
                                                <label id="mainstorage1" class="form-control-static"></label>
                                            </td>
                                            <td>
                                                <div id="mainstorageaddstockdiv1" class="form-group">
                                                    <input type="text" id="mainstorageaddstock1" class='form-control'></input>
                                                    <label id="mainstorageaddstocklbvalidate1" class="form-control-static"></label>
                                                </div>
                                            </td>
                                            <td>
                                                
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                <img src="images/plus.png" height="20" width="20" id="btnadd1" onmouseover="" style="cursor:pointer;">
                                              
                        </div>
                    </div>           
                </div>
        </div>
</div>
</div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="button" id="btnconfirm" class="btn btn-primary update" value="Nhập"></input> <input type="button" id="btncancel1" class="btn btn-danger remove" value="Hủy"></input>  
</form>
<script type="text/javascript" charset="utf-8">
var y = 5;
    $( document ).ready(function()
    {
        var where = {"store": 1};   
        for (var y = 2; y <= 5; y++) 
        {
            $("#tbody1").append("<tr id='onestoretr"+y+"'><td><div id='ingredientlistdiv"+y+"' class='form-group'><select id='ingredientlist"+y+"' onchange='ChangeIngredient("+y+");' class='form-control'><option value='0'>Nguyên liệu</option></select></div></td><td><label id='mainstorage"+y+"'></label></td><td><div id='mainstorageaddstockdiv"+y+"' class='form-group'><input type='text' id='mainstorageaddstock"+y+"' class='form-control'></input><label id='mainstorageaddstocklbvalidate"+y+"' class='form-control-static'></label></div></td><td><img src='images/minus.png' height='20' width='20' id='"+y+"' onmouseover='' style='cursor:pointer;' onclick='deleterow1("+y+");'></td></tr>");
        
        };
        var arrAdded = [];
        //Input ingredient into dropdown list
        $.post("/services/model",{from:"IngredientStore", populate:["ingredient"], where:JSON.stringify(where)},function(result)
        {            
            var hasValue = false;
            for(var i=1; i<=y;i++)
            {
                for(var l=0;l<result.IngredientStore.length;l++)
                {
                    $("#ingredientlist"+i+"").append("<option value='"+result.IngredientStore[l].id+"'>"+result.IngredientStore[l].ingredient.name+"</option>");

                    

                    //Check low inventory
                    //If instock <= limit
                    if(result.IngredientStore[l].instock <= result.IngredientStore[l].limit)
                    {
                        //If not added to the list
                        if(arrAdded.indexOf(result.IngredientStore[l].ingredient.id) == -1)
                        {
                            var notification_row = arrAdded.length+1;
                            $("#tbody-notification").append("<tr id='tr-notification"+notification_row+"'><td>"+result.IngredientStore[l].id+"</td><td>"+result.IngredientStore[l].ingredient.name+"</td><td>"+result.IngredientStore[l].ingredient.description+"</td><td>"+result.IngredientStore[l].ingredient.price+"</td><td>"+result.IngredientStore[l].ingredient.unit+"</td></tr>");
                            arrAdded.push(result.IngredientStore[l].ingredient.id);
                        }      
                        hasValue = true;                  
                    }
                }   
            }
            if(!hasValue)
                $("#notification").hide();
        });   
    });
    
//All functions related to table one store
    function deleterow1(row)//delete one row in one store table
    {
        
        if(row==y)//case: user delete the lastest row
        {
            y=y-1;
            $("#onestoretr"+row+"").remove();
        };
        if(row<y)//case: user delete middle row
        {
            for (var i = row; i<y; i++) 
            {
                var n = i+1;
                var test = $("#ingredientlist"+n+"").val();
                $("#ingredientlist"+i+"").val(test);
                $("#mainstorage"+i+"").text($("#mainstorage"+n+"").text());
                $("#mainstorageaddstock"+i+"").val($("#mainstorageaddstock"+n+"").val());

            };
            $("#onestoretr"+y+"").remove();
            y=y-1;
        };
    };
    $("#btncancel1").click(function()//cancel all choices from onestore table
    {
        $("#deleteform").modal();
    });
    
    $("#btncancel3").click(function()//cancel all choices from onestore table
    {
    window.location.reload();
    });

    function add() {
        //Get all tr
        var trs = $("#tbody-notification").find("tr");
        var tbody1 = $("#tbody1").find("tr");

        if(trs.length > 0) {
            //If the table below has less row than the above one => add more
            if(tbody1.length < trs.length) {
                for(var i = tbody1.length+1; i <= trs.length; i++) {
                    appendRow(i);
                }
                y = trs.length;
            }

            var ingredient_id, count = 1;

            $.each(trs, function() {
                //Get First td
                ingredient_id = $(this).find("td:nth-child(1)").text();
                
                //Set value to dropdownlist
                $("#ingredientlist"+count+"").val(ingredient_id);

                //Change column "Tồn kho"
                ChangeIngredient(count);
                count++;
            });
        }
    }
    
    function ChangeIngredient(row)
    {
        for (var i = 1; i <=y; i++) 
        {
            if($("#ingredientlist"+row+"").val()==$("#ingredientlist"+i+"").val()&&row!=i&&$("#ingredientlist"+row+"").val()!=0)//check if user chose this ingredient or not
            {
                alert("Bạn đã chọn nguyên liệu này rồi!");
                $("#ingredientlist"+row+"").val(0);
                $("#mainstorage"+row+"").text("");
                $("#mainstorageaddstock"+row+"").val("");
                return false;
            };
        };
        var ingredientid = $("#ingredientlist"+row+"").val();
        //get stock depend on chosen ingredient***********************
        if(ingredientid==0)
        {
            $("#mainstorage"+row+"").text("");
            $("#mainstorageaddstock"+row+"").val("");
            return false;
        };
        var where = {"id":ingredientid};
        //get the stock in main storage of chosen ingredient
        $.post("/services/model",{from:"ingredientStore", where: JSON.stringify(where)},function(result1)
            {
                if(result1.status==0)
                {
                    alert("Kho tổng không có nguyên liệu này!");
                    return false;
                }
                $("#mainstorage"+row+"").text(result1.IngredientStore[0].instock);
            });
    };
    $("#btnadd1").click(function()
    {
        if(y>=20)
        {
            alert("Bạn đã vượt quá số lượng hàng cho phép (20)!");
            return false;
        }
        y=y+1;
        appendRow(y);       
    });

    function appendRow(y) {        
        $("#tbody1").append("<tr id='onestoretr"+y+"'><td><select id='ingredientlist"+y+"' onchange='ChangeIngredient("+y+");'><option value='0'>Nguyên liệu</option></select></td><td><label id='mainstorage"+y+"'></label></td><td><input type='text' id='mainstorageaddstock"+y+"'></input></td><td><img src='images/minus.png' height='20' width='20' id='"+y+"' onmouseover='' style='cursor:pointer;' onclick='deleterow1("+y+");'></td></tr>");
        $("#ingredientlist"+y+"").empty();
        // $("#ingredientlist"+y+"").append("<option value='0'>Nguyên liệu</option>");

        $("#ingredientlist"+y+"").append($("#ingredientlist1").html());

        /*var where = {"store":1};
        $.post("/services/model",{from:"IngredientStore", populate:["ingredient"], where:JSON.stringify(where)},function(result)
        {
                for(var l=0;l<result.IngredientStore.length;l++)
                {
                    $("#ingredientlist"+y+"").append("<option value='"+result.IngredientStore[l].id+"'>"+result.IngredientStore[l].ingredient.name+"</option>");
                }   
        });*/
    }

    $("#btnchange1").click(function()
    {
        $("#confirmform").modal('hide');
        var flag = 0;
        var error =0;
        if($("#datepicker").val()=="")
        {
            alert("Bạn chưa chọn ngày xuất kho!");
            $("#datepickerdiv").attr('class','form-group has-error');
            return false;
        }
        if(/^(?:(?:31(\/)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/)0?2\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)\d{2})$/.test($("#datepicker").val())==false)
        {
            $("#datepickerdiv").attr('class','form-group has-error');
            alert("Ngày nhập kho phải theo định dạng mm/dd/yyyy và đúng thực tế!");
            return false;
        };
        if($("#receipt").val()=="")
        {
            alert("Bạn chưa nhập số hóa đơn!");
            $("#receiptdiv").attr('class','form-group has-error');
            return false;
        }
        for (var i = 1; i <=y; i++) 
        {
            if($("#onestoretr"+i+"").length)//check if the row is deleted or not
            {
                if($("#ingredientlist"+i+"").val()!=0&&$("#mainstorageaddstock"+i+"").val()!="")
                {
                    flag =1;
                    if(/^[0-9]+$/.test($("#mainstorageaddstock"+i+"").val())==false)
                    {
                        alert("#"+i+" Số lượng nguyên liệu cần chuyển không hợp lệ!");
                        return false;
                    };
                    if($("#mainstorageaddstock"+i+"").val()>1000000000)
                    {
                        alert("#"+i+" Số lượng nguyên liệu cần chuyển không được lớn hơn 1000000000");
                        return false;
                    };
                    //Export inggrdients***************************************
                    var ingredientid = $("#ingredientlist"+i+"").val();
                    var oldstock = parseInt($("#mainstorage"+i+"").text());
                    var stock = parseInt($("#mainstorageaddstock"+i+"").val());
                    var newstock = oldstock+stock;
                    var updatedata= {"instock":newstock};
                    $.post("/services/model",{from:"IngredientStore",action:"update",updatedata:JSON.stringify(updatedata),where:ingredientid},function(result3)
                    {
                        if(result3.status==0)
                        {
                            alert("#"+i+""+result3.message+"");
                            return false;
                        }
                    });            
                };
                if($("#ingredientlist"+i+"").val()!=0&&$("#mainstorageaddstock"+i+"").val()=="")
                {
                    alert("#"+i+" Bạn chưa nhập số lượng nguyên liệu cần chuyển!");
                    return false;
                };
                if($("#ingredientlist"+i+"").val()==0&&$("#mainstorageaddstock"+i+"").val()!="")
                {
                    alert("#"+i+" Bạn chưa chọn nguyên liệu cần chuyển!");
                    return false;
                };
            }
        };
        var receiptid = $("#receipt").val();
        $.post("services/model",{"from":"ImportReceipt"},function(result)
        {
            for (var i = 0; i < result.ImportReceipt.length; i++) 
            {
                if(receiptid==result.ImportReceipt[i].receiptid)
                {
                    alert("Số hóa đơn này đã tồn tại, xin vui lòng kiểm tra lại!");
                    $("#receiptdiv").attr('class','form-group has-error');
                    error= 1;
                    return false;
                }
            };
            if(error==1)
            {
                return false;
            }
        //input importreceipt
            if(error==0)
            {
        var time = $( "#datepicker" ).datepicker( "option", "dateFormat", "mm/dd/yy" ).val();
        var note = $("#note").val();
        var user = 1;//edit later
        var amount= [];
        var idlist = [];
        var price = [];
        var dem = 1;
        var ImportReceiptData = {"receiptid":receiptid,"time":time,"note":note,"user":user};
        $.post("services/model",{"from":"ImportReceipt","action":"create","createdata":JSON.stringify(ImportReceiptData)},function(result4)
        {

            if(result4.status==1)//input ImportReceipt successfully
            {
                //get the key id of receipt
                var where1= {"receiptid":receiptid};
                $.post("services/model",{"from":"ImportReceipt","where":JSON.stringify(where1)},function(result5)
                {
                    if(result5.status==1)
                    {
                        var receiptkeyid = result5.ImportReceipt[0].id;
                        for (var i = 1; i <=y; i++) 
                        {
                            if($("#onestoretr"+i+"").length)//check if the row is deleted or not
                            {
                                if($("#ingredientlist"+i+"").val()!=0&&$("#mainstorageaddstock"+i+"").val()!="")
                                {
                                    amount.push(parseFloat($("#mainstorageaddstock"+i+"").val()));
                                    var ingreid = $("#ingredientlist"+i+"").val();
                                    var where2 = {"id":ingreid};
                                    $.post("services/model",{"from":"IngredientStore","where":JSON.stringify(where2)},function(result6)
                                        {
                                            if(result6.status==1)
                                            {
                                                idlist.push(result6.IngredientStore[0].ingredient);
                                                //get unit price
                                                var idingre = result6.IngredientStore[0].ingredient;
                                                var where3 = {"id":idingre};
                                                $.post("services/model",{"from":"Ingredient","where":JSON.stringify(where3)},function(result7)
                                                {
                                                    if(result7.status==1)
                                                    {
                                                        price.push(result7.Ingredient[0].price);
                                                        if(dem==amount.length)
                                                        {
                                                            for (var k = 0; k <amount.length; k++) 
                                                            {
                                                                var total = amount[k]*price[k];
                                                                var data= {"receiptid":receiptkeyid,"amount":amount[k],"ingredient":idlist[k],"unitprice":price[k],"total":total};
                                                                $.post("services/model",{"from":"ImportReceiptItem","action":"create","createdata":JSON.stringify(data)},function(result8)
                                                                    {
                                                                        if(result8.status==1)
                                                                        {
                                                                            
                                                                        }
                                                                        else
                                                                        {
                                                                            alert("Thất bại");
                                                                            return false;
                                                                        }
                                                                    });




                                                            };
                                                            alert("Bạn đã chuyển nguyên liệu thành công!");
                                                            window.location.reload();
                                                        }
                                                        else
                                                        {
                                                            dem= dem+1;
                                                        }

                                                    }
                                                    else
                                                    {
                                                        alert("Thất bại");
                                                        return false;
                                                    }
                                                });
                                            }
                                            if(result6.status==0)
                                            {
                                                alert("Thất bại");
                                                return false;
                                            }
                                        });
                                }
                            }
                        }
                    }
                    else 
                    {
                        alert("Không lấy được id hóa đơn!");
                        return false;
                    }    
                    });
            }
                else//fail to input ImportReceipt
                {
                    alert("Lưu hóa đơn không thành công!");
                    return false;
                }
                });
            }
        });
        if(flag==0)
        {
            alert("Bạn phải chuyển ít nhất một nguyên liệu!");
            return false;
        }
        /*alert("Bạn đã chuyển nguyên liệu thành công!");
        window.location.reload();*/
});
 $(function() {//datepicker code
    $( "#datepicker" ).datepicker();
    $( "#datepicker" ).datepicker( "option", "dateFormat", "dd/mm/yy" );
});
function ChangeDate()
  {
    if(/^(?:(?:31(\/)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/)0?2\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)\d{2})$/.test($("#datepicker").val())==true)
    {
        $("#datepickerdiv").attr('class','form-group has-success');
        $("#datepickerlbvalidate").text("");
        return true;
    };
    if(/^(?:(?:31(\/)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/)0?2\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)\d{2})$/.test($("#datepicker").val())==false)
    {
        $("#datepickerdiv").attr('class','form-group has-error');
        $("#datepickerlbvalidate").text("Ngày xuất kho phải theo định dạng mm/dd/yyyy và đúng thực tế!");
        return false;
    };
    }
function receiptvalidate()
  {
    if($("#receipt").val()=="")
    {
        $("#receiptdiv").attr('class','form-group has-error');
        $("#receiptlbvalidate").text("Số hóa đơn không được bỏ trống!");
        return false;
    }
    if(/^[a-zA-Z0-9]+$/.test($("#receipt").val())==false)
    {
        $("#receiptlbvalidate").text("Số hóa đơn không hợp lệ");
        $("#receiptdiv").attr('class','form-group has-error');
        return false;
    };
    if($("#receipt").val().length<3||$("#receipt").val().length>7)
    {
        $("#receiptlbvalidate").text("Số hóa đơn phải từ 3 đến 7 kí tự!");
        $("#receiptdiv").attr('class','form-group has-error');
        return false;
    }
    $("#receiptdiv").attr('class','form-group has-success');
    $("#receiptlbvalidate").text("");
  };
  function ChangeTextArea()
  {
    if($("#note").val()=="")
    {
        $("#notediv").attr('class','form-group');
        $("#notelbvalidate").text("");
        return false;
    }
    if($("#note").val().length>255)
    {
        $("#notediv").attr('class','form-group has-error');
        $("#notelbvalidate").text("Số kí tự cho phép là 255 kí tự!");
        alert("Bạn đã vượt quá kí tự cho phép ở mục Ghi chú!");
        return false;
    }
    $("#notediv").attr('class','form-group has-success');
    $("#notelbvalidate").text("");

  }
  //modal
   $("#btnconfirm").click(function()
    {
        $("#confirmform").modal();
    });
</script>