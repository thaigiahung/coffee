<link rel="stylesheet" href="//code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.3/jquery-ui.js"></script>

<!-- List of all low inventory ingredient -->
<div id="notification">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">Danh sách nguyên liệu cần nhập kho</h1>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover" id="list-item">
                            <thead>
                                <tr>
                                    <th>Mã kho</th>
                                    <th>Nguyên liệu</th>
                                    <th>Mô tả</th>
                                    <th>Giá</th>
                                    <th>Đơn vị</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-notification">
                                
                            </tbody>
                        </table>
                    </div>
                    <!-- /.table-responsive -->
                    <div class="text-center">
                        <button type="submit" id="btnAdd" onClick="add()" class="btn btn-lg btn-primary add">Nhập nguyên liệu</button>                    
                    </div>
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <!-- /.col-lg-12 -->
    </div>
</div>
<!-- End of List of all low inventory ingredient -->


<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Nhập kho</h1>
    </div> 
</div>
<div id="deleteform" class="modal fade">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Cảnh báo</h4>
              </div>
              <div class="modal-body">
                Bạn có chắc muốn hủy bỏ tất cả mọi thông tin đã nhập không?

              </div>
              <div class="modal-footer">
                <button type="button"  class="btn btn-primary update" data-dismiss="modal">Không</button>
                <button type="button" id="btncancel3" class="btn btn-danger remove">Có</button>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
<div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class= "panel-body">
                    <div class="table-responsive">
                        <div  id="onestore">
                            <form>
                                <table class="table table-striped table-bordered table-hover">
                                    <thead>
                                        <th>
                                            Nguyên liệu
                                        </th>
                                        <th>
                                            Tồn kho
                                        </th>
                                        <th>
                                            Số lượng nhập
                                        </th>
                                        <th>
                                            
                                        </th>
                                    </thead>
                                    <tbody id="tbody1">
                                        <tr id="onestoretr1">
                                            <td>
                                                <select id="ingredientlist1" onchange="ChangeIngredient(1);">
                                                    <option value="0">
                                                        Nguyên liệu
                                                    </option>
                                                </select>
                                            </td>
                                            <td>
                                                <label id="mainstorage1"></label>
                                            </td>
                                            <td>
                                                <input type="text" id="mainstorageaddstock1"></input>
                                            </td>
                                            <td>
                                                
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                <img src="images/plus.png" height="20" width="20" id="btnadd1" onmouseover="" style="cursor:pointer;">
                                              
                        </div>
                    </div>           
                </div>
        </div>
</div>
</div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="button" id="btnchange1" class="btn btn-primary update" value="Nhập"></input> <input type="button" id="btncancel1" class="btn btn-danger remove" value="Hủy"></input>  
</form>
<script type="text/javascript" charset="utf-8">
var y = 5;
    $( document ).ready(function()
    {
        var where = {"store": 1};   
        for (var y = 2; y <= 5; y++) 
        {
            $("#tbody1").append("<tr id='onestoretr"+y+"'><td><select id='ingredientlist"+y+"' onchange='ChangeIngredient("+y+");'><option value='0'>Nguyên liệu</option></select></td><td><label id='mainstorage"+y+"'></label></td><td><input type='text' id='mainstorageaddstock"+y+"'></input></td><td><img src='images/minus.png' height='20' width='20' id='"+y+"' onmouseover='' style='cursor:pointer;' onclick='deleterow1("+y+");'></td></tr>");
        
        };
        var arrAdded = [];
        //Input ingredient into dropdown list
        $.post("/services/model",{from:"IngredientStore", populate:["ingredient"], where:JSON.stringify(where)},function(result)
        {            
            var hasValue = false;
            for(var i=1; i<=y;i++)
            {
                for(var l=0;l<result.IngredientStore.length;l++)
                {
                    $("#ingredientlist"+i+"").append("<option value='"+result.IngredientStore[l].id+"'>"+result.IngredientStore[l].ingredient.name+"</option>");

                    

                    //Check low inventory
                    //If instock <= limit
                    if(result.IngredientStore[l].instock <= result.IngredientStore[l].limit)
                    {
                        //If not added to the list
                        if(arrAdded.indexOf(result.IngredientStore[l].ingredient.id) == -1)
                        {
                            var notification_row = arrAdded.length+1;
                            $("#tbody-notification").append("<tr id='tr-notification"+notification_row+"'><td>"+result.IngredientStore[l].id+"</td><td>"+result.IngredientStore[l].ingredient.name+"</td><td>"+result.IngredientStore[l].ingredient.description+"</td><td>"+result.IngredientStore[l].ingredient.price+"</td><td>"+result.IngredientStore[l].ingredient.unit+"</td></tr>");
                            arrAdded.push(result.IngredientStore[l].ingredient.id);
                        }      
                        hasValue = true;                  
                    }
                }   
            }
            if(!hasValue)
                $("#notification").hide();
        });   
    });
    
//All functions related to table one store
    function deleterow1(row)//delete one row in one store table
    {
        
        if(row==y)//case: user delete the lastest row
        {
            y=y-1;
            $("#onestoretr"+row+"").remove();
        };
        if(row<y)//case: user delete middle row
        {
            for (var i = row; i<y; i++) 
            {
                var n = i+1;
                var test = $("#ingredientlist"+n+"").val();
                $("#ingredientlist"+i+"").val(test);
                $("#mainstorage"+i+"").text($("#mainstorage"+n+"").text());
                $("#mainstorageaddstock"+i+"").val($("#mainstorageaddstock"+n+"").val());

            };
            $("#onestoretr"+y+"").remove();
            y=y-1;
        };
    };
    $("#btncancel1").click(function()//cancel all choices from onestore table
    {
        $("#deleteform").modal();
    });
    
    $("#btncancel3").click(function()//cancel all choices from onestore table
    {
    window.location.reload();
    });

    function add() {
        //Get all tr
        var tds_id = $("#tbody-notification").find("tr");
        if(tds_id.length > 0) {
            var ingredient_id, count = 1;

            $.each(tds_id, function() {
                //By default, we only have 5 row
                //If tds_id > 5, we must append new row
                if(count > 5) {
                    appendRow(count);
                }

                //Get First td
                ingredient_id = $(this).find("td:nth-child(1)").text();
                
                //Set value to dropdownlist
                $("#ingredientlist"+count+"").val(ingredient_id);

                //Change column "Tồn kho"
                ChangeIngredient(count);
                count++;
            });
        }
    }
    
    function ChangeIngredient(row)
    {
        for (var i = 1; i <=y; i++) 
        {
            if($("#ingredientlist"+row+"").val()==$("#ingredientlist"+i+"").val()&&row!=i&&$("#ingredientlist"+row+"").val()!=0)//check if user chose this ingredient or not
            {
                alert("Bạn đã chọn nguyên liệu này rồi!");
                $("#ingredientlist"+row+"").val(0);
                $("#mainstorage"+row+"").text("");
                $("#mainstorageaddstock"+row+"").val("");
                return false;
            };
        };
        var ingredientid = $("#ingredientlist"+row+"").val();
        //get stock depend on chosen ingredient***********************
        if(ingredientid==0)
        {
            $("#mainstorage"+row+"").text("");
            $("#mainstorageaddstock"+row+"").val("");
            return false;
        };
        var where = {"id":ingredientid};
        //get the stock in main storage of chosen ingredient
        $.post("/services/model",{from:"ingredientStore", where: JSON.stringify(where)},function(result1)
            {
                if(result1.status==0)
                {
                    alert("Kho tổng không có nguyên liệu này!");
                    return false;
                }
                $("#mainstorage"+row+"").text(result1.IngredientStore[0].instock);
            });
    };
    $("#btnadd1").click(function()
    {
        if(y>=20)
        {
            alert("Bạn đã vượt quá số lượng hàng cho phép (20)!");
            return false;
        }
        y=y+1;
        appendRow(y);       
    });

    function appendRow(y) {        
        $("#tbody1").append("<tr id='onestoretr"+y+"'><td><select id='ingredientlist"+y+"' onchange='ChangeIngredient("+y+");'><option value='0'>Nguyên liệu</option></select></td><td><label id='mainstorage"+y+"'></label></td><td><input type='text' id='mainstorageaddstock"+y+"'></input></td><td><img src='images/minus.png' height='20' width='20' id='"+y+"' onmouseover='' style='cursor:pointer;' onclick='deleterow1("+y+");'></td></tr>");
        $("#ingredientlist"+y+"").empty();
        // $("#ingredientlist"+y+"").append("<option value='0'>Nguyên liệu</option>");

        $("#ingredientlist"+y+"").append($("#ingredientlist1").html());

        /*var where = {"store":1};
        $.post("/services/model",{from:"IngredientStore", populate:["ingredient"], where:JSON.stringify(where)},function(result)
        {
                for(var l=0;l<result.IngredientStore.length;l++)
                {
                    $("#ingredientlist"+y+"").append("<option value='"+result.IngredientStore[l].id+"'>"+result.IngredientStore[l].ingredient.name+"</option>");
                }   
        });*/
    }

    $("#btnchange1").click(function()
    {
        var flag = 0;
        for (var i = 1; i <=y; i++) 
        {
            if($("#onestoretr"+i+"").length)//check if the row is deleted or not
            {
                if($("#ingredientlist"+i+"").val()!=0&&$("#mainstorageaddstock"+i+"").val()!="")
                {
                    flag =1;
                    if(/^[0-9]+$/.test($("#mainstorageaddstock"+i+"").val())==false)
                    {
                        alert("#"+i+" Số lượng nguyên liệu cần chuyển không hợp lệ!");
                        return false;
                    };
                    if($("#mainstorageaddstock"+i+"").val()>1000000000)
                    {
                        alert("#"+i+" Số lượng nguyên liệu cần chuyển không được lớn hơn 1000000000");
                        return false;
                    };
                    //Export inggrdients***************************************
                    var ingredientid = $("#ingredientlist"+i+"").val();
                    var oldstock = parseInt($("#mainstorage"+i+"").text());
                    var stock = parseInt($("#mainstorageaddstock"+i+"").val());
                    var newstock = oldstock+stock;
                    var updatedata= {"instock":newstock};
                    $.post("/services/model",{from:"IngredientStore",action:"update",updatedata:JSON.stringify(updatedata),where:ingredientid},function(result3)
                    {
                        if(result3.status==0)
                        {
                            alert("#"+i+""+result3.message+"");
                            return false;
                        }
                    });            
                };
                if($("#ingredientlist"+i+"").val()!=0&&$("#mainstorageaddstock"+i+"").val()=="")
                {
                    alert("#"+i+" Bạn chưa nhập số lượng nguyên liệu cần chuyển!");
                    return false;
                };
                if($("#ingredientlist"+i+"").val()==0&&$("#mainstorageaddstock"+i+"").val()!="")
                {
                    alert("#"+i+" Bạn chưa chọn nguyên liệu cần chuyển!");
                    return false;
                };
            }
        };
        if(flag==0)
        {
            alert("Bạn phải chuyển ít nhất một nguyên liệu!");
            return false;
        }
        alert("Bạn đã chuyển nguyên liệu thành công!");
        window.location.reload();
        /*$.post("/ingredient/export/set",{option:1,data:JSON.stringify(data)},function(result2)
        {
            if(result2.status==1)
            {
            alert(result2.message);
            window.location.reload();
            }
            if(result2.status==0)
            {
                alert(result2.message+", xin vui lòng kiểm tra lại số lượng đã nhập.");
                return false;
            }
        });*/
    });
</script>