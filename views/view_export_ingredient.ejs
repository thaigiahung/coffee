<link rel="stylesheet" href="//code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.3/jquery-ui.js"></script>

<!-- List of all low inventory ingredient -->
<div id="notification">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">Danh sách nguyên liệu cần xuất kho</h1>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-body">
                    <select id="low-inventory-store" onchange="ChangeLowInventoryStore()" class="form-control">
                        <% _.each(stores, function (store) { %>
                            <option value="<%= store.store %>"><%= store.name %></option>
                        <% }) %>
                    </select>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover" id="list-item">
                            <thead>
                                <tr>
                                    <th>Mã kho</th>
                                    <th>Nguyên liệu</th>
                                    <th>Mô tả</th>
                                    <th>Giá</th>
                                    <th>Đơn vị</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-notification">
                                
                            </tbody>
                        </table>
                    </div>
                    <!-- /.table-responsive -->
                    <div class="text-center">
                        <button type="submit" id="btnAdd" onClick="add()" class="btn btn-lg btn-primary add">Xuất nguyên liệu</button>                    
                    </div>
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <!-- /.col-lg-12 -->
    </div>
</div>
<!-- End of List of all low inventory ingredient -->

<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Xuất kho</h1>
    </div> 
</div>
<div id="deleteform" class="modal fade">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Cảnh báo</h4>
              </div>
              <div class="modal-body">
                Bạn có chắc muốn hủy bỏ tất cả mọi thông tin đã nhập không?

              </div>
              <div class="modal-footer">
                <button type="button"  class="btn btn-primary update" data-dismiss="modal">Không</button>
                <button type="button" id="btncancel3" class="btn btn-danger remove">Có</button>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <div id="confirmform" class="modal fade">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Xác nhận</h4>
              </div>
              <div class="modal-body">
                Bạn có chắc muốn thực hiện lệnh xuất kho không?

              </div>
              <div class="modal-footer">
                <button type="button"  class="btn btn-primary update" data-dismiss="modal">Không</button>
                <button type="button" id="btnchange1" data-dismiss="modal" class="btn btn-danger remove">Có</button>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
<div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class= "panel-body">
                	<div class="table-responsive">
                
                        <div  id="onestore">
                            <form>
                                <div id="allstoreslistdiv" class="form-group">
                                    <select id="allstoreslist" onchange="ChangeStore();" class="form-control">
                                        <option value="0">Cửa hàng</option>
                                        <% _.each(allStores, function (store) { %>
                                            <option value="<%= store.id %>"><%= store.name %></option>
                                        <% }) %>
                                    </select>
                                    <label id="allstoreslistlbvalidate" class="form-control-static"></label>
                                </div>
                    <div id="datepickerdiv" class="form-group">
                                                <input class="form-control" type="text" id="datepicker" placeholder=" Ngày xuất kho" onchange="ChangeDate();" onkeyup="ChangeDate();" onpaste="ChangeDate();" oninput="ChangeDate();">
                                                <label id="datepickerlbvalidate" class="form-control-static"></label>
                                            </div>
                                             <div id="receiptdiv" class="form-group">
                                                <input class="form-control" type="text" id="receipt" placeholder=" Số hóa đơn" onkeyup="receiptvalidate();" onpaste="receiptvalidate();" oninput="receiptvalidate();">
                                                <label id="receiptlbvalidate" class="form-control-static"></label>
                                            </div>
                                            <div id="notediv" class="form-group">
                                                <b>Ghi chú:</b>
                                                <textarea class="form-control" rows="3" id="note" onkeyup="ChangeTextArea();" onpaste="ChangeTextArea();" oninput="ChangeTextArea();"></textarea>
                                                <label class="form-control-static" id="notelbvalidate"></label>
                                            </div>
                                <table class="table table-striped table-bordered table-hover" >
                                    <thead>
                                        <th>
                                            Hàng
                                        </th>
                                        <th>
                                            Nguyên liệu
                                        </th>
                                        <th>
                                            Kho tổng
                                        </th>
                                        <th>
                                            Tồn kho
                                        </th>
                                        <th>
                                            Giá nhập
                                        </th>
                                        <th>
                                            Giá xuất
                                        </th>
                                        <th>
                                            Số lượng chuyển
                                        </th>
                                        <th>
                                            
                                        </th>
                                    </thead>
                                    <tbody id="tbody1">
                                        <tr id="onestoretr1">
                                            <td>
                                                <b>#1</b>
                                            </td>
                                            <td>
                                                <div id="onestoreingredientlistdiv1" class="form-group">
                                                <select class="form-control" id="onestoreingredientlist1" onchange="ChangeIngredient(1);">
                                                    <option value="0">
                                                        Nguyên liệu
                                                    </option>
                                                </select>
                                            </div>
                                            </td>
                                            <td>
                                                <label id="onestoreMain1" class="form-control-static"></label>
                                            </td>
                                            <td>
                                                <label id="onestoreLocal1" class="form-control-static"></label>
                                            </td>
                                            <td>
                                                <label id="onestoreimportprice1" class="form-control-static"></label>
                                            </td>
                                            <td>
                                                <div id="onestoreexportpricediv1" class="form-group">
                                                    <input type="text" id="onestoreexportprice1" class="form-control"></input>
                                                    <label id="onestoreexportpricelbvalidate1" class="form-control-static"></label>
                                                </div>
                                            </td>
                                            <td>
                                                <div id="onestoreaddstockdiv1" class="form-group ">
                                                <input type="text" id="onestoreaddstock1" class="form-control" onkeyup="validate(1);" onpaste="validate(1);" oninput="validate(1);"></input>
                                                <label id="lbvalidate1" class="form-control-static"></label>
                                            </div>
                                            </td>
                                            <td>
                                                
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                <img src="images/plus.png" height="20" width="20" id="btnadd1" onmouseover="" style="cursor:pointer;">
                                              
                        </div>
                    </div>           
                </div>
        </div>
</div>
</div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="button" id="btnconfirm" class="btn btn-primary update" value="Chuyển"></input> <input class="btn btn-danger remove" type="button" id="btncancel1" value="Hủy"></input>  
</form>
<script type="text/javascript" charset="utf-8">
var y = 5;
    $( document ).ready(function()
    {
        
        for (var y = 2; y <= 5; y++) 
        {
            $("#tbody1").append("<tr id='onestoretr"+y+"'><td><b>#"+y+"</b></td><td><div id='onestoreingredientlistdiv"+y+"' class='form-group'><select id='onestoreingredientlist"+y+"' onchange='ChangeIngredient("+y+");' class='form-control'><option value='0'>Nguyên liệu</option></select></div></td><td><label id='onestoreMain"+y+"' class='form-control-static'></label></td><td><label class='form-control-static' id='onestoreLocal"+y+"'></label></td><td><label id='onestoreimportprice"+y+"' class='form-control-static'></label></td><td><div id='onestoreexportpricediv"+y+"' class='form-group'><input type='text' id='onestoreexportprice"+y+"' class='form-control'></input><label id='onestoreexportpricelbvalidate"+y+"' class='form-control-static'></label></div></td><td><div id='onestoreaddstockdiv"+y+"' class='form-group'><input class='form-control' type='text' id='onestoreaddstock"+y+"' onkeyup='validate("+y+");' onpaste='validate("+y+");' oninput='validate("+y+");'></input><label id='lbvalidate"+y+"' class='form-control-static'></label></div></td><td><img src='images/minus.png' height='20' width='20' id='"+y+"' onmouseover='' style='cursor:pointer;' onclick='deleterow1("+y+");'></td></tr>");
            $("#onestoreingredientlist"+y+"").empty();
            $("#onestoreingredientlist"+y+"").append("<option value='0'>Nguyên liệu</option>");
        };

        //Check low inventory
        var options = $("#low-inventory-store").find("option");
        if(options.length > 0) { //Low inventory                        
            $("#low-inventory-store").val($("#low-inventory-store option:first").val());
            ChangeLowInventoryStore();
        }
        else { //No need to import any ingredient
            $("#notification").hide();
        }        
    });
    //All functions related to table one store
    function deleterow1(row)//delete one row in one store table
    {
        
        if(row==y)//case: user delete the lastest row
        {
            y=y-1;
            $("#onestoretr"+row+"").remove();
        };
        if(row<y)//case: user delete middle row
        {
            for (var i = row; i<y; i++) 
            {
                var n = i+1;
                var test = $("#onestoreingredientlist"+n+"").val();
                $("#onestoreingredientlist"+i+"").val(test);
                $("#onestoreMain"+i+"").text($("#onestoreMain"+n+"").text());
                $("#onestoreLocal"+i+"").text($("#onestoreLocal"+n+"").text());
                $("#onestoreaddstock"+i+"").val($("#onestoreaddstock"+n+"").val());
                $("#onestoreingredientlistdiv"+i+"").attr('class',$("#onestoreingredientlistdiv"+n+"").attr('class'));
                $("#onestoreaddstockdiv"+i+"").attr('class',$("#onestoreaddstockdiv"+n+"").attr('class'));
                $("#lbvalidate"+i+"").text($("#lbvalidate"+n+"").text());


            };
            $("#onestoretr"+y+"").remove();
            y=y-1;
        };
    };

    $("#btncancel1").click(function()//cancel all choices from onestore table
    {
        $('#deleteform').modal();
    });

    $("#btnconfirm").click(function()
    {
        $("#confirmform").modal();
    });

    $("#btncancel3").click(function()
    {
        
            window.location.reload(); 
    });

    function ChangeStore()
    {
        var store = $("#allstoreslist").val();
        if(store==0)
        {
            $("#allstoreslistdiv").attr('class','form-group has-error');
        }
        for (var i = 1; i <=y; i++) 
        {
            $("#onestoreingredientlist"+i+"").empty();
            $("#onestoreMain"+i+"").text("");
            $("#onestoreLocal"+i+"").text("");
            $("#onestoreaddstock"+i+"").val("");
            $("#onestoreingredientlist"+i+"").append("<option value='0'>Nguyên liệu</option>");
            $("#lbvalidate"+i+"").text("");
            $("#onestoreaddstockdiv"+i+"").attr('class','form-group');
        };
        
        if(store!=0)
        {
            $("#allstoreslistdiv").attr('class','form-group has-success');
            //get ingredient list depend on chosen store
            
            var name1 = [];
            var idlist = [];
            $.post("services/model",{"from":"ingredient"},function(result7)
            {
                if(result7.status==0)
                {
                    alert("Không tìm thấy nguyên liệu nào trên hệ thống, vui lòng kiểm tra lại!");
                    return false;
                }
                if(result7.status==1)
                {
                    var dem=1;
                    for (var i = 0; i < result7.Ingredient.length; i++) 
                    {
                        if(result7.Ingredient[i].deleted==0)
                        {
                            var idmainingre=result7.Ingredient[i].id;
                            name1.push(result7.Ingredient[i].name);
                            var where5 = {"store":store,"ingredient":idmainingre};
                            $.post("services/model",{"from":"IngredientStore",where:JSON.stringify(where5)},function(result8)
                            {
                                if(result8.status==1)
                                {
                                idlist.push(result8.IngredientStore[0].id);
                                 if(dem==name1.length)
                                 {
                                    for (var l = 1; l <=y; l++) 
                                    {
                                        for (var m = 0; m < dem; m++) 
                                        {
                                        $("#onestoreingredientlist"+l+"").append("<option value ='"+idlist[m]+"'  id='ingredient1? "+idlist[m]+"'>"+name1[m]+"</option>");
                                        };
                                    };
                                    
                                 }
                                 else
                                 {
                                    dem=dem+1;
                                 }
                                    
                                    
                                /*$("#onestoreingredientlist"+l+"").append("<option value ='"+result8.IngredientStore[0].ingredient+"'  id='ingredient1? "+result8.IngredientStore[0].ingredient+"'>"+name1+"</option>");*/
                                }
                                if(result8.status==0)
                                {
                                    alert("fail");
                                }
                            });
                        }
                    };
                }
            })


            /*$.getJSON("http://localhost:1337/ingredient/show/"+store+"",function(datas1)
            {
                if(datas1.status==0)//check if the store has any kinds of ingredient
                {
                    for (var i = 1; i <=y; i++) 
                    {
                        $("#onestoreMain"+i+"").text("");
                        //$("#onestoreingredientlist"+i+"").append("<option value = '0'>Nguyên liệu</option>");
                    };
                    alert("Cửa hàng này không có nguyên liệu nào!");
                    return false;
                    
                }
                for (var l = 1; l <=y; l++) 
                {
                    for (var i = 0; i < datas1.ingredient.length; i++) 
                {
                    $("#onestoreingredientlist"+l+"").append("<option value ='"+datas1.ingredient[i].ingredientid+"'  id='ingredient1? "+datas1.ingredient[i].ingredientid+"'>"+datas1.ingredient[i].ingredientname+"</option>");
                };
                };
                
            });*/
        };
    };

    function ChangeIngredient(row)
    {
        for (var i = 1; i <=y; i++) 
        {
            if($("#onestoreingredientlist"+row+"").val()==$("#onestoreingredientlist"+i+"").val()&&row!=i&&$("#onestoreingredientlist"+row+"").val()!=0)//check if user chose this ingredient or not
            {
                alert("Bạn đã chọn nguyên liệu này rồi!");
                $("#onestoreingredientlist"+row+"").val(0);
                $("#onestoreMain"+row+"").text("");
                $("#onestoreLocal"+row+"").text("");
                return false;
            };
        };
        var ingredientid = $("#onestoreingredientlist"+row+"").val();
        //get stock depend on chosen ingredient***********************
        if(ingredientid==0)
        {
            $("#onestoreingredientlistdiv"+row+"").attr('class','form-group');
            $("#onestoreMain"+row+"").text("");
            $("#onestoreLocal"+row+"").text("");
            $("#lbvalidate"+row+"").text("");
            $("#onestoreaddstockdiv"+row+"").attr('class','form-group');
            $("#onestoreaddstock"+row+"").val("");
        };
        if(ingredientid!=0)
        {
        $("#onestoreingredientlistdiv"+row+"").attr('class','form-group has-success');
        var where = {"id":ingredientid};
        var populate1=["ingredient"];
        $.post("/services/model",{from:"ingredientStore",where: JSON.stringify(where),populate:JSON.stringify(populate1)},function(result)
        {            
            //get the stock in main storage of chosen ingredient
            var where1= {"ingredient":result.IngredientStore[0].ingredient.id,"store":1};
            $.post("/services/model",{from:"ingredientStore", where: JSON.stringify(where1)},function(result1)
            {
                if(result1.status==0)
                {
                    alert("Kho tổng không có nguyên liệu này!");
                    return false;
                }
                $("#onestoreMain"+row+"").text(result1.IngredientStore[0].instock);
            });
            //get the stock of chosen ingredient from chose store
            $("#onestoreLocal"+row+"").text(result.IngredientStore[0].instock);
            $("#onestoreimportprice"+row+"").text(result.IngredientStore[0].ingredient.price);
        });
    }
    };

    function ChangeLowInventoryStore() {        
        var store = $("#low-inventory-store").val();

        //Change the below store like the chosen above
        //The reason for loading this before clicking "Xuất Nguyên Liêu" is because
        //it is async, if we don't load it before, at the time we add the list above to the
        //below one, the dropdown list ingredient is not loaded yet => dropdown list
        //will choose an empty line
        $("#allstoreslist").val(store);
        ChangeStore();

        var where = {"store": store};
        $.post("/services/model",{from:"IngredientStore", populate:["ingredient"], where:JSON.stringify(where)},function(result)
        {
            $("#tbody-notification").empty();
            if(result.IngredientStore.length > 0) {
                for(var i = 0; i < result.IngredientStore.length; i++) {
                    if(result.IngredientStore[i].instock <= result.IngredientStore[i].limit) {
                        $("#tbody-notification").append("<tr id='tr-notification"+i+"'><td>"+result.IngredientStore[i].id+"</td><td>"+result.IngredientStore[i].ingredient.name+"</td><td>"+result.IngredientStore[i].ingredient.description+"</td><td>"+result.IngredientStore[i].ingredient.price+"</td><td>"+result.IngredientStore[i].ingredient.unit+"</td></tr>");    
                    }                                    
                }
            }            
        });
    }

    function add() {  
        //Get all tr
        var tds_id = $("#tbody-notification").find("tr");
        if(tds_id.length > 0) {
            var ingredient_id, count = 1;

            $.each(tds_id, function() {
                //By default, we only have 5 row
                //If tds_id > 5, we must append new row
                if(count > 5) {
                    appendRow(count);
                }

                //Get First td
                ingredient_id = $(this).find("td:nth-child(1)").text();
                console.log(ingredient_id);
                //Set value to dropdownlist
                $("#onestoreingredientlist"+count).val(ingredient_id);

                //Change column "Tồn kho"
                ChangeIngredient(count);
                count++;
            });
        }
    }

    $("#btnadd1").click(function()
    {        
        if(y>=20)
        {
            alert("Bạn đã vượt quá số lượng hàng cho phép (20)!");
            return false;
        }
        y=y+1;
        appendRow(y);
    });

    function appendRow (row) {
        var store = $("#allstoreslist").val();
        $("#tbody1").append("<tr id='onestoretr"+row+"'><td><b>#"+row+"</b></td><td><div id='onestoreingredientlistdiv"+row+"' class='form-group'><select class='form-control' id='onestoreingredientlist"+row+"' onchange='ChangeIngredient("+row+");'><option value='0'>Nguyên liệu</option></select></td><td><label class='form-control-static' id='onestoreMain"+row+"'></label></td><td><label id='onestoreLocal"+row+"' class='form-control-static'></label></td><td><div id='onestoreaddstockdiv"+row+"' class='form-group'><input class='form-control' type='text' id='onestoreaddstock"+row+"' onkeyup='validate("+row+");' onpaste='validate("+row+");' oninput='validate("+row+");'></input><label id='lbvalidate"+row+"' class='form-control-static'></label></div></td><td><img src='images/minus.png' height='20' width='20' id='"+row+"' onmouseover='' style='cursor:pointer;' onclick='deleterow1("+row+");'></td></tr>");
        $("#onestoreingredientlist"+row+"").empty();
        $("#onestoreingredientlist"+row+"").append("<option value='0'>Nguyên liệu</option>");

        if(store!=0)
        {
            $.getJSON("http://localhost:1337/ingredient/show/"+store+"",function(datas1)
            {
                for (var i = 0; i < datas1.ingredient.length; i++) 
                {
                    $("#onestoreingredientlist"+row+"").append("<option value ='"+datas1.ingredient[i].ingredientid+"'  id='ingredient1? "+datas1.ingredient[i].ingredientid+"'>"+datas1.ingredient[i].ingredientname+"</option>");
                };
            });
        }
    }

    $("#btnchange1").click(function()
    {
        $("#confirmform").modal('hide');
        var flag = 0;
        var data = [];
        var error= 0;
        var receiptid = $("#receipt").val();
        if($("#allstoreslist").val()==0)//check if user chose store or not
        {
            alert("Bạn chưa chọn cửa hàng để chuyển nguyên liệu!");
            $("#allstoreslistdiv").attr('class','form-group has-error');
            return false;
        }
        if($("#datepicker").val()=="")
        {
            alert("Bạn chưa chọn ngày xuất kho!");
            $("#datepickerdiv").attr('class','form-group has-error');
            return false;
        }
        if(/^(?:(?:31(\/)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/)0?2\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)\d{2})$/.test($("#datepicker").val())==false)
        {
            $("#datepickerdiv").attr('class','form-group has-error');
            alert("Ngày xuất kho phải theo định dạng mm/dd/yyyy và đúng thực tế!");
            return false;
        };
        if($("#receipt").val()=="")
        {
            alert("Bạn chưa nhập số hóa đơn!");
            $("#receiptdiv").attr('class','form-group has-error');
            return false;
        }
        

        for (var i = 1; i <=y; i++) 
        {
            if($("#onestoretr"+i+"").length)//check if the row is deleted or not
            {
                if($("#onestoreingredientlist"+i+"").val()!=0&&$("#onestoreaddstock"+i+"").val()!="")
                {
                    flag =1;
                    if(/^[0-9]+$/.test($("#onestoreaddstock"+i+"").val())==false)
                    {
                        alert("#"+i+" Số lượng nguyên liệu cần chuyển không hợp lệ!");
                        $("#onestoreaddstockdiv"+i+"").attr('class','form-group has-error');
                        return false;
                    };
                    if($("#onestoreaddstock"+i+"").val()>1000000000)
                    {
                        alert("#"+i+" Số lượng nguyên liệu cần chuyển không được lớn hơn 1000000000");
                        return false;
                    };
                    //Export inggrdients***************************************
                    var ingredientid = $("#onestoreingredientlist"+i+"").val();
                    var stock = parseInt($("#onestoreaddstock"+i+"").val());
                    var obj = {"ingredientid":ingredientid,"stock":stock};
                    data.push(obj);

                    

                };
                if($("#onestoreingredientlist"+i+"").val()!=0&&$("#onestoreaddstock"+i+"").val()=="")
                {
                    alert("#"+i+" Bạn chưa nhập số lượng nguyên liệu cần chuyển!");
                    $("#lbvalidate"+i+"").text("Bạn chưa nhập số lượng nguyên liệu cần chuyển!");
                    $("#onestoreaddstockdiv"+i+"").attr('class','form-group has-error');
                    return false;
                };
                if($("#onestoreingredientlist"+i+"").val()==0&&$("#onestoreaddstock"+i+"").val()!="")
                {
                    alert("#"+i+" Bạn chưa chọn nguyên liệu cần chuyển!");
                    $("#onestoreingredientlistdiv"+i+"").attr('class','form-group has-error');
                    return false;
                };
            }
        };
        if(flag==0)
        {
            alert("Bạn phải chuyển ít nhất một nguyên liệu!");
            return false;
        }
        $.post("services/model",{"from":"ExportReceipt"},function(result)
        {
            for (var i = 0; i < result.ExportReceipt.length; i++) 
            {
                if(receiptid==result.ExportReceipt[i].receiptid)
                {
                    alert("Số hóa đơn này đã tồn tại, xin vui lòng kiểm tra lại!");
                    $("#receiptdiv").attr('class','form-group has-error');
                    error= 1;
                    return false;
                }
            };
            if(error==1)
            {
                return false;
            }
            if(error==0)
            {
                //Input Receipt Information
                //var user= 1;//save for editing later
                var note = $("#note").val();
                var time = $( "#datepicker" ).datepicker( "option", "dateFormat", "mm/dd/yy" ).val();//format date to input into db
                var amount=[];
                var ingreid=[];
                var price = [];
                var dem =1;
                var data1 = {"receiptid":receiptid,"time":time,"note":note};
                $.post("services/model",{"from":"ExportReceipt","action":"create","createdata":JSON.stringify(data1)},function(result)
                {
                    if(result.status ==1)
                    {
                        
                        var where2= {"receiptid":receiptid};
                        //get the id of Receipt
                        $.post("services/model",{"from":"ExportReceipt","where":JSON.stringify(where2)},function(result3)
                        {
                            if(result3.status==1)
                            {
                                var idreceipt = result3.ExportReceipt[0].id;
                                //get id of the main ingredient
                                for (var i = 1; i <=y; i++) 
                                {
                                    if($("#onestoretr"+i+"").length)//check if the row is deleted or not
                                    {
                                        if($("#onestoreingredientlist"+i+"").val()!=0&&$("#onestoreaddstock"+i+"").val()!="")
                                         {

                                    
                                            amount.push(parseFloat($("#onestoreaddstock"+i+"").val()));
                                            var ingredientid1 = parseInt($("#onestoreingredientlist"+i+"").val());
                                            var where3={"id":ingredientid1};
                                    $.post("services/model",{"from":"IngredientStore","where":JSON.stringify(where3)},function(result4){
                                        if(result4.status==1)
                                        {
                                             ingreid.push(result4.IngredientStore[0].ingredient);
                                            var ingreid1 = result4.IngredientStore[0].ingredient;
                                            //get unitprice
                                            var where4 = {"id":ingreid1};
                                            $.post("services/model",{"from":"ingredient","where":JSON.stringify(where4)},function(result5){
                                                if(result5.status==1)
                                                {
                                                    
                                                        
                                                        price.push(result5.Ingredient[0].price);
                                                        if(dem==amount.length)
                                                        {
                                                        for (var i = 0; i < amount.length; i++) 
                                                            {
                                                                var total = amount[i]*price[i];
                
                                                                var receiptitemdata= {"receiptid":idreceipt,"ingredient":ingreid[i],"amount":amount[i],"unitprice":price[i],"total":total};
                                                                $.post("services/model",{"from":"ExportReceiptItem","action":"create","createdata":JSON.stringify(receiptitemdata)},function(result6)
                                                                {
                                                                    if(result6.status==1)
                                                                    {
                                                                        
                                                                    }
                                                                    if(result6.status==0)
                                                                    {
                                                                        alert("Thất bại");
                                                                        return false;
                                                                    };
                                                                });

                                                            };
                                                            window.location.reload();
                                                        }
                                                        else
                                                        {
                                                            dem=dem+1;
                                                        }
                                                        /*var receiptitemdata = {"receiptid":idreceipt,"amount":amount[d],"ingredient":};
                                                        $.post("services/model",{"from":"ExportReceiptItem","action":"create","createdata"},);*/

                                                    
                                                    /*var price = result5.Ingredient[0].price;
                                                    alert(idreceipt);
                                                    alert(ingreid);
                                                    alert(amount);
                                                    alert(price);
                                                    var total = amount*price;
                                                    alert(total);*/
                                                }

                                            });
                                        
                                        }
                                    });
                                    }
                                }

                            };
                            }
                                
                            if(result3.status==0)
                            {
                                return false;
                            }
                        });
                    }
                    if(result.status==0)
                    {
                        alert("Không thể lưu thông tin hóa đơn xuất kho!");
                        return false;
                    }
                });
            }
        });

            /* //Input Receipt Information
                //var user= 1;//save for editing later
                var note = $("#note").val();
                var time = $( "#datepicker" ).datepicker( "option", "dateFormat", "mm/dd/yy" ).val();//format date to input into db
                var data1 = {"receiptid":receiptid,"time":time,"note":note};
                $.post("services/model",{"from":"ExportReceipt","action":"create","createdata":JSON.stringify(data1)},function(result)
                {
                    if(result.status ==1)
                    {
                        //input receiptitem
                        alert("Lưu hóa đơn thành công");
                    }
                    if(result.status==0)
                    {
                        alert("Không thể lưu thông tin hóa đơn xuất kho!");
                        return false;
                    }
                });*/  
            $.post("/ingredient/export/set",{option:1,data:JSON.stringify(data)},function(result2)
        {
            if(result2.status==1)
            {
            alert(result2.message);
            }
            if(result2.status==0)
            {
                alert(result2.message+", xin vui lòng kiểm tra lại số lượng đã nhập.");
                return false;
            }
        });
    });
  $(function() {//datepicker code
    $( "#datepicker" ).datepicker();
    $( "#datepicker" ).datepicker( "option", "dateFormat", "dd/mm/yy" );
});

  function ChangeDate()
  {
    if(/^(?:(?:31(\/)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/)0?2\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)\d{2})$/.test($("#datepicker").val())==true)
    {
        $("#datepickerdiv").attr('class','form-group has-success');
        $("#datepickerlbvalidate").text("");
        return true;
    };
    if(/^(?:(?:31(\/)(?:0?[13578]|1[02]))\1|(?:(?:29|30)(\/)(?:0?[1,3-9]|1[0-2])\2))(?:(?:1[6-9]|[2-9]\d)?\d{2})$|^(?:29(\/)0?2\3(?:(?:(?:1[6-9]|[2-9]\d)?(?:0[48]|[2468][048]|[13579][26])|(?:(?:16|[2468][048]|[3579][26])00))))$|^(?:0?[1-9]|1\d|2[0-8])(\/)(?:(?:0?[1-9])|(?:1[0-2]))\4(?:(?:1[6-9]|[2-9]\d)\d{2})$/.test($("#datepicker").val())==false)
    {
        $("#datepickerdiv").attr('class','form-group has-error');
        $("#datepickerlbvalidate").text("Ngày xuất kho phải theo định dạng mm/dd/yyyy và đúng thực tế!");
        return false;
    };

    }
  function validate(row)
  {
    var flag = 0;
    var data = [];

            if($("#onestoretr"+row+"").length)//check if the row is deleted or not
            {
                if($("#onestoreingredientlist"+row+"").val()!=0&&$("#onestoreaddstock"+row+"").val()=="")
                {
                    $("#lbvalidate"+row+"").text("Bạn chưa nhập số lượng nguyên liệu cần chuyển!");
                    $("#onestoreaddstockdiv"+row+"").attr('class','form-group has-error');
                    return false;
                };
                if($("#onestoreingredientlist"+row+"").val()==0&&$("#onestoreaddstock"+row+"").val()=="")
                {
                    $("#lbvalidate"+row+"").text("");
                    $("#onestoreaddstockdiv"+row+"").attr('class','form-group');
                    return false;
                };
                    if(/^[0-9]+$/.test($("#onestoreaddstock"+row+"").val())==false)
                    {
                        $("#lbvalidate"+row+"").text("Số lượng nguyên liệu cần chuyển không hợp lệ!");
                        $("#onestoreaddstockdiv"+row+"").attr('class','form-group has-error');
                        return false;
                    };
                    if($("#onestoreaddstock"+row+"").val()>1000000000)
                    {
                        $("#lbvalidate"+row+"").text("Số lượng nguyên liệu cần chuyển không được lớn hơn 1000000000");
                        $("#onestoreaddstockdiv"+row+"").attr('class','form-group has-error');
                        return false;
                    };       
            }
            $("#onestoreaddstockdiv"+row+"").attr('class','form-group has-success');
            $("#lbvalidate"+row+"").text("");
    
  };
  function receiptvalidate()
  {
    if($("#receipt").val()=="")
    {
        $("#receiptdiv").attr('class','form-group has-error');
        $("#receiptlbvalidate").text("Số hóa đơn không được bỏ trống!");
        return false;
    }
    if(/^[a-zA-Z0-9]+$/.test($("#receipt").val())==false)
    {
        $("#receiptlbvalidate").text("Số hóa đơn không hợp lệ");
        $("#receiptdiv").attr('class','form-group has-error');
        return false;
    };
    if($("#receipt").val().length<3||$("#receipt").val().length>7)
    {
        $("#receiptlbvalidate").text("Số hóa đơn phải từ 3 đến 7 kí tự!");
        $("#receiptdiv").attr('class','form-group has-error');
        return false;
    }
    $("#receiptdiv").attr('class','form-group has-success');
    $("#receiptlbvalidate").text("");
  };
  function ChangeTextArea()
  {
    if($("#note").val()=="")
    {
        $("#notediv").attr('class','form-group');
        $("#notelbvalidate").text("");
        return false;
    }
    if($("#note").val().length>255)
    {
        $("#notediv").attr('class','form-group has-error');
        $("#notelbvalidate").text("Số kí tự cho phép là 255 kí tự!");
        alert("Bạn đã vượt quá kí tự cho phép ở mục Ghi chú!");
        return false;
    }
    $("#notediv").attr('class','form-group has-success');
    $("#notelbvalidate").text("");

  }
</script>